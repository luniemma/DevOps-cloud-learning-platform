# =============================================================================
# REUSABLE BUILD AND DEPLOY WORKFLOW (Docker Hub Version)
# Place this in: DevOps-cloud-learning-platform/.github/workflows/build-deploy-reusable.yml
# =============================================================================
name: Reusable Build and Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (staging, production)'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag override'
        required: false
        type: string
        default: ''
      deploy_method:
        description: 'Deployment method (kustomize, helm)'
        required: false
        type: string
        default: 'kustomize'
      skip_tests:
        description: 'Skip lint and test steps'
        required: false
        type: boolean
        default: false
      namespace:
        description: 'Kubernetes namespace'
        required: false
        type: string
        default: 'devops-learning'
      use_dockerhub:
        description: 'Use Docker Hub instead of GHCR'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AKS_CLUSTER_NAME:
        required: true
      AKS_RESOURCE_GROUP:
        required: true
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false
    outputs:
      image_tag:
        description: 'Deployed image tag'
        value: ${{ jobs.build.outputs.image_tag }}
      image_digest:
        description: 'Deployed image digest'
        value: ${{ jobs.build.outputs.image_digest }}
      deployment_url:
        description: 'Deployment URL'
        value: ${{ jobs.deploy.outputs.deployment_url }}

jobs:
  # ===========================================================================
  # LINT AND TEST
  # ===========================================================================
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    if: inputs.skip_tests == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm test || echo "No tests found"
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: Summary
        run: |
          echo "### ðŸ§ª Test Results - Passed âœ…" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # BUILD AND PUSH
  # ===========================================================================
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: always() && (needs.lint-and-test.result == 'success' || needs.lint-and-test.result == 'skipped')
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}
      full_image: ${{ steps.registry.outputs.image }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Registry
        id: registry
        run: |
          if [ "${{ inputs.use_dockerhub }}" == "true" ]; then
            echo "registry=docker.io" >> $GITHUB_OUTPUT
            echo "image=${{ secrets.DOCKERHUB_USERNAME }}/devops-learning-platform" >> $GITHUB_OUTPUT
            echo "Using Docker Hub"
          else
            echo "registry=ghcr.io" >> $GITHUB_OUTPUT
            echo "image=ghcr.io/${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "Using GitHub Container Registry"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: inputs.use_dockerhub == true
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        if: inputs.use_dockerhub == false
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.registry.outputs.image }}
          tags: |
            type=raw,value=${{ inputs.image_tag }},enable=${{ inputs.image_tag != '' }}
            type=sha,prefix=${{ inputs.environment }}-
            type=raw,value=${{ inputs.environment }}-latest
            type=raw,value=latest,enable=${{ inputs.environment == 'production' }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build Summary
        run: |
          echo "### ðŸ³ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | ${{ steps.registry.outputs.registry }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.registry.outputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # DEPLOY
  # ===========================================================================
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.url.outputs.deployment_url }}
    outputs:
      deployment_url: ${{ steps.url.outputs.deployment_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Setup kubectl and kubelogin
        run: |
          # kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          # kubelogin
          curl -LO "https://github.com/Azure/kubelogin/releases/download/v0.1.4/kubelogin-linux-amd64.zip"
          unzip -o kubelogin-linux-amd64.zip -d kubelogin-extract
          sudo mv kubelogin-extract/bin/linux_amd64/kubelogin /usr/local/bin/
          rm -rf kubelogin-extract kubelogin-linux-amd64.zip

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing
          
          kubelogin convert-kubeconfig -l azurecli

      - name: Create namespace
        run: |
          kubectl create namespace ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Registry Secret
        if: inputs.use_dockerhub == true
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --namespace=${{ inputs.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Kustomize
        if: inputs.deploy_method == 'kustomize'
        run: |
          echo "Deploying with Kustomize..."
          
          # Map environment names
          OVERLAY="${{ inputs.environment }}"
          if [ "$OVERLAY" == "prod" ]; then
            OVERLAY="production"
          fi
          
          # Check if overlay exists
          if [ -d "k8s/overlays/$OVERLAY" ]; then
            kubectl apply -k k8s/overlays/$OVERLAY
          else
            echo "Overlay not found at k8s/overlays/$OVERLAY, using base"
            kubectl apply -k k8s/base
          fi
          
          # Update image
          kubectl set image deployment/devops-learning-app \
            app=${{ needs.build.outputs.full_image }}@${{ needs.build.outputs.image_digest }} \
            -n ${{ inputs.namespace }}
          
          # Add image pull secret if using Docker Hub
          if [ "${{ inputs.use_dockerhub }}" == "true" ]; then
            kubectl patch deployment devops-learning-app \
              -n ${{ inputs.namespace }} \
              -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"dockerhub-secret"}]}}}}'
          fi
          
          # Wait for rollout
          kubectl rollout status deployment/devops-learning-app \
            -n ${{ inputs.namespace }} \
            --timeout=300s

      - name: Deploy with Helm
        if: inputs.deploy_method == 'helm'
        run: |
          echo "Deploying with Helm..."
          
          # Install Helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          
          # Map environment
          VALUES_ENV="${{ inputs.environment }}"
          if [ "$VALUES_ENV" == "prod" ]; then
            VALUES_ENV="production"
          fi
          
          # Check for values file
          VALUES_ARG=""
          if [ -f "helm/devops-learning/values-${VALUES_ENV}.yaml" ]; then
            VALUES_ARG="-f helm/devops-learning/values-${VALUES_ENV}.yaml"
          fi
          
          # Set image pull secret for Docker Hub
          PULL_SECRET_ARG=""
          if [ "${{ inputs.use_dockerhub }}" == "true" ]; then
            PULL_SECRET_ARG="--set imagePullSecrets[0].name=dockerhub-secret"
          fi
          
          helm upgrade --install devops-learning ./helm/devops-learning \
            --namespace ${{ inputs.namespace }} \
            --create-namespace \
            $VALUES_ARG \
            --set image.repository=${{ needs.build.outputs.full_image }} \
            --set image.tag=${{ needs.build.outputs.image_tag }} \
            --set environment=${{ inputs.environment }} \
            $PULL_SECRET_ARG \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          echo "### ðŸš€ Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pods:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ inputs.namespace }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n ${{ inputs.namespace }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Get Deployment URL
        id: url
        run: |
          # Try ingress
          HOST=$(kubectl get ingress -n ${{ inputs.namespace }} -o jsonpath='{.items[0].spec.rules[0].host}' 2>/dev/null || echo "")
          
          if [ -n "$HOST" ]; then
            URL="https://$HOST"
          else
            # Try LoadBalancer
            IP=$(kubectl get svc -n ${{ inputs.namespace }} -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$IP" ]; then
              URL="http://$IP"
            else
              URL="http://cluster-internal"
            fi
          fi
          
          echo "deployment_url=$URL" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $URL" >> $GITHUB_STEP_SUMMARY