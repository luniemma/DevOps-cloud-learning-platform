# =============================================================================
# MAIN CI/CD WORKFLOW (Docker Hub Version)
# Place this in: DevOps-cloud-learning-platform/.github/workflows/ci-cd.yml
# =============================================================================
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      deploy_method:
        description: 'Deployment method'
        required: false
        type: choice
        options:
          - kustomize
          - helm
        default: 'kustomize'
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false
  
  # Triggered from AKS infrastructure repo
  repository_dispatch:
    types: [deploy-app, aks-ready]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # ===========================================================================
  # SETUP
  # ===========================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      should_deploy: ${{ steps.config.outputs.should_deploy }}
      deploy_method: ${{ steps.config.outputs.deploy_method }}
      skip_tests: ${{ steps.config.outputs.skip_tests }}
    steps:
      - name: Determine Configuration
        id: config
        run: |
          DEPLOY="false"
          SKIP_TESTS="false"
          DEPLOY_METHOD="kustomize"
          
          # Repository dispatch (from AKS repo)
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ENV="${{ github.event.client_payload.environment || 'staging' }}"
            DEPLOY="true"
            SKIP_TESTS="${{ github.event.client_payload.skip_tests || 'false' }}"
            DEPLOY_METHOD="${{ github.event.client_payload.deploy_method || 'kustomize' }}"
          
          # Manual dispatch
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
            DEPLOY="true"
            SKIP_TESTS="${{ inputs.skip_tests }}"
            DEPLOY_METHOD="${{ inputs.deploy_method }}"
          
          # Push to main = production
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
            DEPLOY="true"
          
          # Push to develop = staging
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
            DEPLOY="true"
          
          # Pull request = tests only
          else
            ENV="staging"
            DEPLOY="false"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$DEPLOY" >> $GITHUB_OUTPUT
          echo "skip_tests=$SKIP_TESTS" >> $GITHUB_OUTPUT
          echo "deploy_method=$DEPLOY_METHOD" >> $GITHUB_OUTPUT
          
          echo "### ðŸŽ¯ Pipeline Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | $ENV |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | $DEPLOY |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Method | $DEPLOY_METHOD |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # PR CHECKS
  # ===========================================================================
  pr-checks:
    name: PR Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm test || echo "No tests configured"
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: PR Summary
        run: |
          echo "### âœ… PR Checks Passed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # BUILD AND DEPLOY
  # ===========================================================================
  deploy:
    name: Build and Deploy
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    uses: ./.github/workflows/build-deploy-reusable.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      deploy_method: ${{ needs.setup.outputs.deploy_method }}
      skip_tests: ${{ needs.setup.outputs.skip_tests == 'true' }}
      namespace: devops-learning
      use_dockerhub: true
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.setup.outputs.should_deploy == 'true'
    steps:
      - name: Deployment Summary
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | ${{ needs.deploy.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
            echo "| URL | ${{ needs.deploy.outputs.deployment_url }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi